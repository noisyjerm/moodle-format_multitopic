{"version":3,"file":"content.min.js","sources":["../../src/courseformat/content.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Course index main component.\n *\n * @module     format_multitopic/courseformat/content\n * @class      format_multitopic/courseformat/content\n * @copyright  2022 James Calder and Otago Polytechnic\n * @copyright  based on work by 2020 Ferran Recio <ferran@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport BaseComponent from 'core_courseformat/local/content';\nimport {getCurrentCourseEditor} from 'core_courseformat/courseeditor';\nimport inplaceeditable from 'core/inplace_editable';\nimport Section from 'format_multitopic/courseformat/content/section';\nimport CmItem from 'core_courseformat/local/content/section/cmitem';\n\nexport default class Component extends BaseComponent {\n\n    /**\n     * Static method to create a component instance form the mustahce template.\n     *\n     * @param {string} target the DOM main element or its ID\n     * @param {object} selectors optional css selector overrides\n     * @param {number} sectionReturn the content section return\n     * @return {Component}\n     */\n    static init(target, selectors, sectionReturn) {\n        return new Component({\n            element: document.getElementById(target),\n            reactive: getCurrentCourseEditor(),\n            selectors,\n            sectionReturn,\n        });\n    }\n\n    /**\n     * Initial state ready method.\n     *\n     * @param {Object} state the state data\n     */\n    stateReady(state) {\n        super.stateReady(state);\n\n        // Set the initial state of collapsible sections.\n        this.fmtCollapseOnHashChange();\n\n        // Capture clicks on course section links.\n        window.addEventListener(\"hashchange\", this.fmtCollapseOnHashChange);\n\n    }\n\n    /**\n     * Expand, and scroll to, the section specified in the URL bar.\n     *\n     * @param {HashChangeEvent?} event The triggering event, if any\n     */\n    fmtCollapseOnHashChange(event) {\n\n        // Find the specified section.\n        var anchor = window.location.hash.substr(1);\n        var selSectionDom = anchor ?\n            document.querySelector(\"body.format-multitopic .course-content ul.sections li.section.section-topic.\" + anchor)\n            : null;\n\n        // Exit if there is an event, but no recognised section.\n        if (event && !selSectionDom) {\n            return;\n        }\n\n        // Expand, if appropriate.\n        if (selSectionDom && selSectionDom.matches(\".section-topic-collapsible\")\n                && selSectionDom.querySelector(\".course-section-header .icons-collapse-expand.collapsed\")) {\n            selSectionDom.querySelector(\".course-section-header .icons-collapse-expand\").click();\n        }\n\n        // Scroll to the specified section.\n        if (selSectionDom) {\n            selSectionDom.scrollIntoView();\n        }\n\n    }\n\n    /**\n     * Handle the collapse/expand all sections button.\n     *\n     * Toggler click is delegated to the main course content element because new sections can\n     * appear at any moment and this way we prevent accidental double bindings.\n     *\n     * @param {Event} event the triggered event\n     */\n    _allSectionToggler(event) {\n        event.preventDefault();\n\n        const target = event.target.closest(this.selectors.TOGGLEALL);\n        const isAllCollapsed = target.classList.contains(this.classes.COLLAPSED);\n\n        let sectionlist = [];\n        const sectionlistDom = document.querySelectorAll(\".course-section.section-topic-collapsible[data-fmtonpage='1']\");\n        for (var sectionCount = 0; sectionCount < sectionlistDom.length; sectionCount++) {\n            sectionlist.push(sectionlistDom[sectionCount].dataset.id);\n        }\n\n        this.reactive.dispatch(\n            'sectionContentCollapsed',\n            sectionlist,\n            !isAllCollapsed\n        );\n    }\n\n    /**\n     * Refresh the collapse/expand all sections element.\n     *\n     * @param {Object} state The state data\n     */\n    _refreshAllSectionsToggler(state) {\n        const target = this.getElement(this.selectors.TOGGLEALL);\n        if (!target) {\n            return;\n        }\n        // Check if we have all sections collapsed/expanded.\n        let allcollapsed = true;\n        let allexpanded = true;\n        let sectionCollapsible = {};\n        const sectionlistDom = document.querySelectorAll(\".course-section.section-topic-collapsible[data-fmtonpage='1']\");\n        for (var sectionCount = 0; sectionCount < sectionlistDom.length; sectionCount++) {\n            sectionCollapsible[sectionlistDom[sectionCount].dataset.id] = true;\n        }\n        state.section.forEach(\n            section => {\n                if (sectionCollapsible[section.id]) {\n                    allcollapsed = allcollapsed && section.contentcollapsed;\n                    allexpanded = allexpanded && !section.contentcollapsed;\n                }\n            }\n        );\n        target.style.display = (allexpanded && allcollapsed) ? \"none\" : \"block\";\n        if (allcollapsed) {\n            target.classList.add(this.classes.COLLAPSED);\n            target.setAttribute('aria-expanded', false);\n        }\n        if (allexpanded) {\n            target.classList.remove(this.classes.COLLAPSED);\n            target.setAttribute('aria-expanded', true);\n        }\n    }\n\n    /**\n     * Update a course section when the section number changes.\n     *\n     * The courseActions module used for most course section tools still depends on css classes and\n     * section numbers (not id). To prevent inconsistencies when a section is moved, we need to refresh\n     * the\n     *\n     * Course formats can override the section title rendering so the frontend depends heavily on backend\n     * rendering. Luckily in edit mode we can trigger a title update using the inplace_editable module.\n     *\n     * @param {Object} param\n     * @param {Object} param.element details the update details.\n     */\n    _refreshSectionNumber({element}) {\n        // Find the element.\n        const target = this.getElement(this.selectors.SECTION, element.id);\n        if (!target) {\n            // Job done. Nothing to refresh.\n            return;\n        }\n        // Update section numbers in all data, css and YUI attributes.\n        target.id = `section-${element.number}`;\n        // YUI uses section number as section id in data-sectionid, in principle if a format use components\n        // don't need this sectionid attribute anymore, but we keep the compatibility in case some plugin\n        // use it for legacy purposes.\n        target.dataset.sectionid = element.number;\n        // The data-number is the attribute used by components to store the section number.\n        target.dataset.number = element.number;\n\n        // Update title and title inplace editable, if any.\n        const inplace = inplaceeditable.getInplaceEditable(target.querySelector(this.selectors.SECTION_ITEM));\n        if (inplace) {\n            // The course content HTML can be modified at any moment, so the function need to do some checkings\n            // to make sure the inplace editable still represents the same itemid.\n            const currentvalue = inplace.getValue();\n            const currentitemid = inplace.getItemId();\n            // Unnamed sections must be recalculated.\n            if (inplace.getValue() === '' || element.timed) { // CHANGED.\n                // The value to send can be an empty value if it is a default name.\n                if (currentitemid == element.id\n                    && (currentvalue != element.rawtitle || element.rawtitle == '' || element.timed)) { // CHANGED.\n                    inplace.setValue(element.rawtitle);\n                }\n            }\n        }\n    }\n\n    /**\n     * Refresh the section list.\n     *\n     * @param {Object} param\n     * @param {Object} param.element details the update details.\n     */\n    _refreshCourseSectionlist({element}) {\n        super._refreshCourseSectionlist({element});\n        const state = this.reactive.stateManager.state;\n        const sections = state.section;\n        const sectionsDom = this.element.querySelectorAll(this.selectors.SECTION);\n        for (var sdi = 0; sdi < sectionsDom.length; sdi++) {\n            const sectionDom = sectionsDom[sdi];\n            const section = sections.get(sectionDom.dataset.id);\n            let refreshCms = false;\n            const pageSectionHTML = this.element.querySelector(\".course-section[data-id='\" + section.pageid + \"']\");\n            const pageSectionDisplay = pageSectionHTML.dataset.fmtonpage;\n            if (sectionDom.dataset.fmtonpage != pageSectionDisplay) {\n                sectionDom.dataset.fmtonpage = pageSectionDisplay;\n                sectionDom.style.display = (pageSectionDisplay == \"1\") ? \"block\" : \"none\";\n                if (pageSectionDisplay == \"1\") {\n                    refreshCms = true;\n                }\n            }\n            if (section.visible == sectionDom.classList.contains(\"hidden\")) {\n                const badgeDom = sectionDom.querySelector(\"span.badge[data-type='hiddenfromstudents']\");\n                if (section.visible) {\n                    sectionDom.classList.remove(\"hidden\");\n                    badgeDom.classList.add(\"d-none\");\n                } else {\n                    sectionDom.classList.add(\"hidden\");\n                    badgeDom.classList.remove(\"d-none\");\n                }\n                if (sectionDom.dataset.fmtonpage == \"1\") {\n                    refreshCms = true;\n                }\n            }\n            if (refreshCms) {\n                // Note: Visibility state doesn't get updated for CMs already rendered.\n                this._refreshSectionCmlist({element: section});\n            }\n        }\n        this._refreshAllSectionsToggler(state);\n    }\n\n    /**\n     * Regenerate content indexes.\n     *\n     * This method is used when a legacy action refresh some content element.\n     */\n    _indexContents() {\n        // Find unindexed sections.\n        this._scanIndex(\n            this.selectors.SECTION,\n            this.sections,\n            (item) => {\n                return new Section(item);\n            }\n        );\n\n        // Find unindexed cms.\n        this._scanIndex(\n            this.selectors.CM,\n            this.cms,\n            (item) => {\n                return new CmItem(item);\n            }\n        );\n    }\n\n}"],"names":["Component","BaseComponent","target","selectors","sectionReturn","element","document","getElementById","reactive","stateReady","state","fmtCollapseOnHashChange","window","addEventListener","this","event","anchor","location","hash","substr","selSectionDom","querySelector","matches","click","scrollIntoView","_allSectionToggler","preventDefault","isAllCollapsed","closest","TOGGLEALL","classList","contains","classes","COLLAPSED","sectionlist","sectionlistDom","querySelectorAll","sectionCount","length","push","dataset","id","dispatch","_refreshAllSectionsToggler","getElement","allcollapsed","allexpanded","sectionCollapsible","section","forEach","contentcollapsed","style","display","add","setAttribute","remove","_refreshSectionNumber","SECTION","number","sectionid","inplace","inplaceeditable","getInplaceEditable","SECTION_ITEM","currentvalue","getValue","currentitemid","getItemId","timed","rawtitle","setValue","_refreshCourseSectionlist","stateManager","sections","sectionsDom","sdi","sectionDom","get","refreshCms","pageSectionDisplay","pageid","fmtonpage","visible","badgeDom","_refreshSectionCmlist","_indexContents","_scanIndex","item","Section","CM","cms","CmItem"],"mappings":"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"}